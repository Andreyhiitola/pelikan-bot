#!/bin/bash
# =============================================================================
# –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è Telegram-–±–æ—Ç–∞ "–ü–µ–ª–∏–∫–∞–Ω –ê–ª–∞–∫–æ–ª—å"
# =============================================================================

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–∏–∑–º–µ–Ω–∏—Ç–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
REPO_DIR="/home/youruser/telegram_bot_pelican_alacol"
VENV_DIR="$REPO_DIR/venv"
BOT_SERVICE="pelikan-bot.service"
GIT_BRANCH="main"

# =============================================================================
# –§—É–Ω–∫—Ü–∏–∏
# =============================================================================

print_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

check_error() {
    if [ $? -ne 0 ]; then
        print_error "$1"
        exit 1
    fi
}

# =============================================================================
# –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è
# =============================================================================

echo "=================================="
echo "  –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –±–æ—Ç–∞ –ü–µ–ª–∏–∫–∞–Ω"
echo "=================================="
echo ""

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
print_info "–ü—Ä–æ–≤–µ—Ä—è—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
if [ ! -d "$REPO_DIR" ]; then
    print_error "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $REPO_DIR –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
    exit 1
fi

cd "$REPO_DIR" || { print_error "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ $REPO_DIR"; exit 1; }
print_info "–†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

# 2. Git pull
print_info "–ü–æ–ª—É—á–∞—é –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ Git (–≤–µ—Ç–∫–∞: $GIT_BRANCH)..."
git fetch origin
check_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ git fetch!"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
LOCAL=$(git rev-parse @)
REMOTE=$(git rev-parse @{u})

if [ "$LOCAL" = "$REMOTE" ]; then
    print_info "–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —É–∂–µ –∞–∫—Ç—É–∞–ª–µ–Ω. –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è."
else
    print_info "–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –û–±–Ω–æ–≤–ª—è—é..."
    git pull origin "$GIT_BRANCH"
    check_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ git pull!"
    print_info "Git pull –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ"
fi

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
print_info "–ü—Ä–æ–≤–µ—Ä—è—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
if [ ! -d "$VENV_DIR" ]; then
    print_warning "–í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –°–æ–∑–¥–∞—é..."
    python3 -m venv "$VENV_DIR"
    check_error "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è!"
fi

# 4. –ê–∫—Ç–∏–≤–∞—Ü–∏—è venv
print_info "–ê–∫—Ç–∏–≤–∏—Ä—É—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
source "$VENV_DIR/bin/activate"
check_error "–ù–µ —É–¥–∞–ª–æ—Å—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ!"

# 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
print_info "–ü—Ä–æ–≤–µ—Ä—è—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
if git diff HEAD@{1} HEAD -- requirements.txt | grep -q .; then
    print_info "requirements.txt –∏–∑–º–µ–Ω–∏–ª—Å—è ‚Äî –æ–±–Ω–æ–≤–ª—è—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
    pip install --upgrade pip
    pip install -r requirements.txt
    check_error "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π!"
else
    print_info "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ"
fi

# 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ .env —Ñ–∞–π–ª–∞
print_info "–ü—Ä–æ–≤–µ—Ä—è—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."
if [ ! -f "$REPO_DIR/.env" ]; then
    print_warning ".env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    print_warning "–°–∫–æ–ø–∏—Ä—É–π—Ç–µ .env.example –≤ .env –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:"
    print_warning "  cp .env.example .env"
    print_warning "  nano .env"
fi

# 7. –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è venv
deactivate

# 8. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
print_info "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å..."

if systemctl is-active --quiet "$BOT_SERVICE"; then
    print_info "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é $BOT_SERVICE..."
    sudo systemctl restart "$BOT_SERVICE"
    check_error "–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ $BOT_SERVICE!"
    sleep 2
    if systemctl is-active --quiet "$BOT_SERVICE"; then
        print_info "‚úì $BOT_SERVICE –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ"
    else
        print_error "‚úó $BOT_SERVICE –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è!"
        sudo systemctl status "$BOT_SERVICE" --no-pager -l
        exit 1
    fi
else
    print_warning "$BOT_SERVICE –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω. –ó–∞–ø—É—Å–∫–∞—é..."
    sudo systemctl start "$BOT_SERVICE"
    check_error "–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ $BOT_SERVICE!"
fi

# 9. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo ""
echo "=================================="
print_info "–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞:"
echo "=================================="
echo ""

sudo systemctl status "$BOT_SERVICE" --no-pager -l | head -n 10

echo ""
echo "=================================="
print_info "‚úì –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ! üöÄ"
echo "=================================="

# 10. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏
echo ""
read -p "–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤ –±–æ—Ç–∞? (y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo ""
    print_info "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ –±–æ—Ç–∞:"
    sudo journalctl -u "$BOT_SERVICE" -n 20 --no-pager
fi
